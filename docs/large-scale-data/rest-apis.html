<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.34">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>rest-apis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-c8ad9e5dbd60b7b70b38521ab19b7da4.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-57255bc51a02dad1602480f616b5f366.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="rest-apis" class="level1">
<h1>REST APIs</h1>
<p>Lets say you’re responsible for software that manages a large database. Maybe it’s your database of customers, or of students, or the database of all products sold by your company; or maybe it’s the geographic data behind Google Maps, or the millions of words of text in Wikipedia. Many people—other teams in your company, random people in the public, other software systems—want to interact with your database to do things.</p>
<p>You could give them direct access. If you use a SQL database system, you could give them access to write their own SQL queries. (Most SQL database software supports permissions, so you could allow certain users to make <code>SELECT</code> queries but not to <code>INSERT</code> or <code>UPDATE</code> data.) But that can cause problems. Your users might write large, complicated queries that are slow to run, and now it’s <em>your</em> problem that your database is working slowly. Also, your users will depend on your specific database schema: if you want to reorganize, change column names, or otherwise change how data is stored, you must now coordinate with everyone who happens to send a <code>SELECT</code> query to you.</p>
<p>When you learned object-oriented programming, you learned about the principle of <em>encapsulation</em>. The internal details of a class should be hidden from the outside world, which can only interact with it through a publicly declared <em>interface</em>. This means the internal details of the class can change—or it can be replaced by an entirely different implementation—without any users having to know the difference.</p>
<p>We often refer to the public interfaces of a product, such as the methods exposed by its classes, as its <em>application programming interface</em> (API). You might hear software engineers referring to a library that provides “an API for reticulating splines”, or complaining that a particular API is too complicated and hard to use. PostgreSQL has a special API for submitting SQL queries and fetching results.</p>
<p>In the spirit of encapsulation, it seems like large databases should have APIs to do common tasks. You can provide an API for the rest of your company to use, and then you can improve the backend (the schema, SQL engine, caching system, and whatever else) without having to coordinate with the rest of the company, which only uses your API. And you’d like this API to be available over the network, so different servers—or random people on their laptops—can make requests to the API.</p>
<p>So how do you build a system that is widely accessible, allows authorized users to submit requests, and returns results, in a way that is convenient, easy to use, and easy to update?</p>
<p>There have been many solutions. For example, <a href="https://en.wikipedia.org/wiki/SOAP">SOAP</a> defines a way to send and receive requests that are written in XML; it was very popular in the early 2000s but soon gained a reputation for being verbose and overly complicated.</p>
<p>A key realization was that HTTP already provides for ways to make requests of remote machines and receive responses from them. Why not provide an API as an HTTP server that responds to specific queries?</p>
<section id="sec-http" class="level2">
<h2 class="anchored" data-anchor-id="sec-http">HTTP</h2>
<p>Let’s briefly recap HTTP, the HyperText Transport Protocol underlying REST APIs and every web page you visit. HTTP is a way to make requests to servers for webpages (or other resources) and receive their responses, and it communicates its data by using protocols like TCP.</p>
<section id="sec-urls" class="level3">
<h3 class="anchored" data-anchor-id="sec-urls">URLs</h3>
<p>Resources available over HTTP (and some other protocols) are identified with <a href="https://en.wikipedia.org/wiki/URL">Uniform Resource Locators</a>.</p>
<p>URLs come in parts; here’s the syntax as given by Wikipedia:</p>
<pre><code>URI = scheme:[//authority]path[?query][#fragment]
authority = [userinfo@]host[:port]</code></pre>
<p>Let’s break that down:</p>
<ul>
<li>Scheme: The type of thing we want. Common schemes are <code>http</code> and <code>https</code> for Web pages, <code>mailto</code> for email links, <code>file</code> for files on the local file system, and so on.</li>
<li>userinfo: A username and potentially a password (as <code>username:password</code>). Optional. Sometimes used for FTP links so the links specifies the username to use. Normally it’s not good to include a password in a URL, because then it’s visible to anyone.</li>
<li>host: A domain name or IP address for the server that owns this content.</li>
<li>port: The port number to use when connecting.</li>
<li>path: A sequence of parts separated by slashes (<code>/</code> – no, these are not backslashes). The path specifies the specific resource or file being requested.</li>
<li>query: Optionally, a query, starting with a question mark. Queries are typically key-value pairs separated by ampersands, as in <code>foo=bar&amp;baz=bin</code>.</li>
<li>fragment: A name, preceded by the hash sign <code>#</code>, pointing to a specific part of the document. For example, in an HTML page, the fragment may refer to a specific section or heading on the page.</li>
</ul>
<p>Some URL examples:</p>
<pre><code>https://en.wikipedia.org/wiki/URL?thing=baz

https://scholar.google.com/citations?user=AxT2apgAAAAJ&amp;hl=en

ftp://alex:hunter2@ftp.example.com/home/alex/passwords</code></pre>
<p>URLs can only contain a specific set of characters (mainly the Latin alphabet, digits, and some punctuation and symbol characters). Everything else must be “URL encoded”, meaning the character is replaced by a percent sign and two hexadecimal digits giving its UTF-8 numeric encoding. (If the encoding is more than one byte, each byte is encoded separately.)</p>
<p>For example, the space character is not permitted in URLs, so it is replaced with <code>%20</code>. Similarly, if we want to use <code>=</code> or <code>&amp;</code> inside a query argument without it being interpreted as separating key-value pairs, we can URL-encode them.</p>
</section>
<section id="requests-and-responses" class="level3">
<h3 class="anchored" data-anchor-id="requests-and-responses">Requests and responses</h3>
<p>An HTTP <em>request</em> is sent by a client (i.e.&nbsp;you) to a server to request a specific resource. It consists of several parts. For example, here’s a request I sent to Wikipedia for the page <a href="https://en.wikipedia.org/wiki/World_Wide_Web" class="uri">https://en.wikipedia.org/wiki/World_Wide_Web</a>:</p>
<pre><code>GET /wiki/World_Wide_Web HTTP/2.0
Host: en.wikipedia.org
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:64.0) Gecko/20100101 Firefox/64.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
DNT: 1
Connection: keep-alive
Cookie: enwikiUserName=Cap%27n+Refsmmat; [more redacted]
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
If-Modified-Since: Sun, 27 Jan 2019 03:20:05 GMT</code></pre>
<p>There’s a lot going on here. Let’s break it down.</p>
<pre><code>GET /wiki/World_Wide_Web HTTP/2.0
Host: en.wikipedia.org</code></pre>
<p>There are several types of HTTP requests, but this is a <code>GET</code> request, using HTTP version 2.0. (See <a href="#sec-http-methods" class="quarto-xref">Section&nbsp;1.1.3</a> for other request types.) The first line specifies the type of request and the specific resource I’m requesting, <code>/wiki/World_Wide_Web</code>. The second line is the beginning of the <em>headers</em>, providing metadata about the request. These headers are in <code>Key: value</code> format, one per line. Here are a few selected headers and their meanings:</p>
<ul>
<li>Host: Specifies domain name I am making the request for – it’s possible for multiple different domain names to have the same IP address, so I have to tell the receiving server which domain name I’m interested in.</li>
<li>User-Agent: Tells the server what kind of program I am. Servers sometimes use this to tell what version of a web page to serve – maybe a page uses some features that only work in Chrome or in specific versions of Internet Explorer. If you’re writing a program that makes HTTP requests, it’s considered good practice to set a User-Agent identifying your program, so if server operators notice it causing a problem, they know who to complain to.</li>
<li>Accept: Specifies the formats of responses I am willing to accept. We’ll see later that some APIs let us specify if we want responses as CSV, JSON, or other formats.</li>
<li>Accept-Encoding: Here my browser says it is willing to receive content compressed with <a href="https://en.wikipedia.org/wiki/Gzip">gzip</a>, <a href="https://en.wikipedia.org/wiki/DEFLATE">DEFLATE</a>, or <a href="https://en.wikipedia.org/wiki/Brotli">Brotli</a>. The server can automatically compress its responses, and the HTTP client automatically decompresses them, saving network bandwidth.</li>
</ul>
<p>After the server receives this request, it can send a response. Responses have a similar format to requests. They begin with a status line and headers:</p>
<pre><code>HTTP/2.0 200 OK
date: Wed, 30 Jan 2019 19:14:42 GMT
content-type: text/html; charset=UTF-8
content-encoding: gzip
[...]</code></pre>
<p>The first line gives the status code 200, meaning “OK”. Other response codes include the famous 404 (“not found”), 403 (“forbidden”), 301 (“moved permanently”), and 418 (<a href="https://www.rfc-editor.org/rfc/rfc2324">“I’m a teapot”</a>). You can find a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">full list on MDN</a>. The client can check the status code to determine if their request was successful.</p>
<p>Subsequent lines give headers for the response. The server has specified the date the response was generated, the type of content, and its encoding; other headers I have omitted set various cookies and give other caching information.</p>
<p>The headers are followed by the response <em>body</em>. In this case, since the <code>Content-Encoding</code> is <code>gzip</code>, the response body is the gzip-compressed HTML of the web page.</p>
</section>
<section id="sec-http-methods" class="level3">
<h3 class="anchored" data-anchor-id="sec-http-methods">HTTP methods</h3>
<p>Above we saw a <code>GET</code> request, which is the simplest and most common type of HTTP request. <code>GET</code> is one of several <em>methods</em> that can be used. The common methods are:</p>
<ul>
<li><code>GET</code>: Retrieve data from a specific resource (i.e.&nbsp;fetch a specific web page). GET requests should not have side effects, like deleting things.</li>
<li><code>POST</code>: Send data to the server so it can do something. Submitting a form to a website often sends a POST request containing the contents of the form. POST requests often have side effects, and automated scrapers should be very careful about submitting POST requests.</li>
<li><code>HEAD</code>: Same as GET, except without the body of the response – only the response headers will be sent.</li>
<li><code>PUT</code>, <code>PATCH</code>, …: Other methods are less commonly used. PUT sends a file to a server and asks it to put it at a specific URL, for example, while PATCH asks for modifications to be made to a file.</li>
</ul>
<p>A POST request can contain arbitrary amounts of data, typically as key-value pairs.</p>
<p>Here’s an example POST request adapted <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/POST">from MDN</a>:</p>
<pre><code>POST /submit HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 13

say=Hi&amp;to=Mom</code></pre>
<p>We’re sending the keys <code>say</code> and <code>to</code> to the server at example.com.</p>
<p>There are other ways of encoding the contents of a POST request; this method is called <code>urlencoded</code> (because the key-value pairs resemble those in the query component of a URL), but we could send JSON or other data formats if the server knows how to read them, and we’d set the <code>Content-Type</code> appropriately.</p>
</section>
<section id="making-http-requests-in-python" class="level3">
<h3 class="anchored" data-anchor-id="making-http-requests-in-python">Making HTTP requests in Python</h3>
<p>There are HTTP packages for almost any programming language. In Python, your best choice is probably <a href="https://requests.readthedocs.io/en/latest/">Requests</a>, which you can install with</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install requests</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The package is fairly straightforward. For example:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.get(<span class="st">"https://en.wikipedia.org/wiki/World_Wide_Web"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                 headers<span class="op">=</span>{<span class="st">"User-Agent"</span>: <span class="st">"toy demo 1.0"</span>})</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>r.status_code <span class="co">#&gt; 200</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>r.text <span class="co">#&gt; "'&lt;!DOCTYPE html&gt;\n&lt;html ..."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To add query parameters, we can either add them to the URL manually, or provide a dictionary of parameters:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.get(<span class="st">"https://forecast.weather.gov/zipcity.php"</span>,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                 params<span class="op">=</span>{<span class="st">"inputstring"</span>: <span class="st">"15213"</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>By providing a dictionary, we allow Requests to do any necessary URL encoding for us, so there’s no problem if one of the values contains <code>&amp;</code> or <code>=</code> characters.</p>
<p>For more details, the <a href="https://requests.readthedocs.io/en/latest/user/quickstart/">requests quickstart guide</a> and <a href="https://requests.readthedocs.io/en/latest/api/">API reference</a> are useful starting points.</p>
</section>
</section>
<section id="rest" class="level2">
<h2 class="anchored" data-anchor-id="rest">REST</h2>
<p>You use HTTP every day when browsing websites. When you open <a href="https://www.instagram.com" class="uri">https://www.instagram.com</a>, your web browser sends a GET request and receives a response; when you post a photo, your browser sends a POST request containing the photo data and information like the photo caption and tags.</p>
<p>But let’s return to the idea of providing an interface to databases. How can we turn HTTP into a general interface for specifying requests, receiving data, and sending updates?</p>
<section id="restful-design" class="level3">
<h3 class="anchored" data-anchor-id="restful-design">RESTful design</h3>
<p>The basic design idea is called <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">representational state transfer</a>, or REST.</p>
<p>REST defines a basic architecture:</p>
<ul>
<li>A client makes requests of a server. The server worries about how to store and manipulate the data; the client just has to specify what it wants.</li>
<li>The requests are <em>stateless</em>. This doesn’t mean they qualify for <a href="https://en.wikipedia.org/wiki/Nansen_passport">Nansen passports</a>; it means that each HTTP request is independent, and doesn’t depend on the previous requests you may have made. This prevents complexity from creeping in.</li>
<li>Resources are identified with URLs. A “resource” might be a web page (as in normal web browsing), but it might also represent a user, an article, a post, or some other thing stored by the system. Each resource as a URL in a specific form.</li>
<li>Operations are done with GET and POST requests to specific URLs. A GET request to the URL for a resource might return information about that resource, while a particular POST request might be used to add or update data.</li>
</ul>
<p>Sometimes the URLs to perform actions are known as <em>endpoints</em>, and so we refer to the “API endpoint” to fetch certain data.</p>
</section>
<section id="rest-over-http" class="level3">
<h3 class="anchored" data-anchor-id="rest-over-http">REST over HTTP</h3>
<p>We can implement this for a particular system by making a web server that responds to HTTP requests by looking up data or modifying it accordingly. Then a client can issue the right requests to read and modify data.</p>
<p>Let’s use a real API to see how this works. GitHub provides a <a href="https://docs.github.com/en/rest">REST API</a> that lets you obtain information about users, repositories, issues, pull requests, and so on. Each of these is a resource. All API requests are sent to <a href="https://api.github.com" class="uri">https://api.github.com</a>, so URLs build on that address.</p>
<p>For example, each user is a resource, and there is a URL for each user. For example, we can make a GET request to <code>/users/{username}</code> to get information about a user with a particular username: <a href="https://api.github.com/users/capnrefsmmat" class="uri">https://api.github.com/users/capnrefsmmat</a></p>
<p>If we open this link in a web browser, we see that GitHub returns data in JSON format about me. The data includes my name and website, my user ID number, and various other details. GitHub also helpfully includes the address of other resources as well, like the <code>repos_url</code> to get a list of all my public Git repositories.</p>
<p>In Requests, we can get this JSON-encoded data into Python.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.get(<span class="st">"https://api.github.com/users/capnrefsmmat"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>r.status_code <span class="co">#&gt; 200</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>r.text <span class="co">#&gt; the text of the JSON-encoded data</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>j <span class="op">=</span> r.json() <span class="co">#&gt; the JSON decoded into a Python dictionary</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>j[<span class="st">'name'</span>] <span class="co">#&gt; Alex Reinhart</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="handling-errors" class="level3">
<h3 class="anchored" data-anchor-id="handling-errors">Handling errors</h3>
<p>For interactive use, this is straightforward enough. But if you’re writing code that wraps the GitHub API in functions, you’ll need to handle errors that might occur. For example, consider the following function:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_github_user(username):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> requests.get(<span class="ss">f"https://api.github.com/users/</span><span class="sc">{</span>username<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r.json()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This fetches the API data for a particular user and returns it as a Python dictionary. It works great – unless there’s a problem. Suppose we were looping through some usernames to do something to each account:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> username <span class="kw">in</span> usernames:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    user_info <span class="op">=</span> get_github_user(username)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    user_login <span class="op">=</span> user_info[<span class="st">"login"</span>]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    user_bio <span class="op">=</span> user_info[<span class="st">"bio"</span>]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    user_avatar <span class="op">=</span> user_info[<span class="st">"avatar_url"</span>]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># do stuff, print stuff, calculate stuff...</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># etc.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now suppose <code>usernames</code> contains an invalid username. We get the following error:</p>
<pre><code>---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
Cell In[8], line 4
      1 for username in usernames:
      2     user_info = get_github_user(username)
----&gt; 4     user_login = user_info["login"]
      5     user_bio = user_info["bio"]
      6     user_avatar = user_info["avatar_url"]

KeyError: 'login'</code></pre>
<p>That’s not helpful! A <code>KeyError</code> means we tried to access a key in the dictionary that does not exist. Evidently the GitHub API returns a different set of data when we request an invalid username, and we’d have to check before using it.</p>
<p>But before we start writing <code>if 'login' in user_info</code>, we should consider what HTTP gives us for free. Each HTTP response has a status code. In this case, GitHub gives a 404 code for invalid usernames:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.get(<span class="st">"https://api.github.com/users/capnrefsm mat"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>r.status_code</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Rather than checking if <code>r.status_code == 404</code>, which wouldn’t cover other error codes, we can let Requests do the work. Here’s an updated version of the function:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_github_user(username):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> requests.get(<span class="ss">f"https://api.github.com/users/</span><span class="sc">{</span>username<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    r.raise_for_status()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r.json()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>raise_for_status()</code> method raises a Python exception if the request failed. Running our loop over usernames again, we get the following error:</p>
<pre><code>---------------------------------------------------------------------------
HTTPError                                 Traceback (most recent call last)
Cell In[16], line 2
      1 for username in usernames:
----&gt; 2     user_info = get_github_user(username)
      4     user_login = user_info["login"]
      5     user_bio = user_info["bio"]

Cell In[15], line 4, in get_github_user(username)
      1 def get_github_user(username):
      2     r = requests.get(f"https://api.github.com/users/{username}")
----&gt; 4     r.raise_for_status()
      6     return r.json()

File ~/miniconda3/lib/python3.10/site-packages/requests/models.py:960, in Response.raise_for_status(self)
    957     http_error_msg = u'%s Server Error: %s for url: %s' % (self.status_code, reason, self.url)
    959 if http_error_msg:
--&gt; 960     raise HTTPError(http_error_msg, response=self)

HTTPError: 404 Client Error: Not Found for url: https://api.github.com/users/capnrefsmm%20at</code></pre>
<p>By raising an exception, we have turned this problem into an error we can handle with standard Python techniques. For example, we could adapt our loop to handle errors:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> username <span class="kw">in</span> usernames:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        user_info <span class="op">=</span> get_github_user(username)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> requests.HTTPError <span class="im">as</span> e:</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Unable to get information for user '</span><span class="sc">{</span>username<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>e<span class="sc">.</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>e<span class="sc">.</span>response<span class="sc">.</span>reason<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    user_login <span class="op">=</span> user_info[<span class="st">"login"</span>]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    user_bio <span class="op">=</span> user_info[<span class="st">"bio"</span>]</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    user_avatar <span class="op">=</span> user_info[<span class="st">"avatar_url"</span>]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># do stuff, print stuff, calculate stuff...</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># etc.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this version, we handle the error (by getting useful information from the exception object) and then proceed to process the rest of the list. Your error-handling strategy may vary depending on the type of problem encountered.</p>
</section>
<section id="authenticating" class="level3">
<h3 class="anchored" data-anchor-id="authenticating">Authenticating</h3>
<p>Many APIs require authentication: you must be an authorized user to access the API or perform certain operations. Because REST requires that APIs be stateless – the server doesn’t have to remember your status between requests – authentication typically involves providing a special token or key with each request you make.</p>
<p>For example, GitHub provides <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token">personal access tokens</a>. If you create such a token, you can use it to access its API. The token is simply a unique random string that is connected to your account. If we don’t provide a token, we only get to see what logged-out users see.</p>
<p>I have a private GitHub repository, and let’s try to get information about it:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.get(<span class="st">"https://api.github.com/repos/capnrefsmmat/think-alouds"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>r.status_code  <span class="co">#=&gt; 404</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice that GitHub says 404 (Not Found) and not 403 (Not Authorized), because it doesn’t want users to be able to find out the names of private repositories – it simply denies all knowledge of them if you don’t have permission to see them.</p>
<p>On the other hand, we can fetch information about the repository if we provide my token:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.get(<span class="st">"https://api.github.com/repos/capnrefsmmat/think-alouds"</span>,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                 headers<span class="op">=</span>{<span class="st">"Authorization"</span>: <span class="st">"Bearer my-token-goes-here"</span>})</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>r.json()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With the right token, this produces a bunch of data:</p>
<pre><code>{'id': 141750320,
 'node_id': 'MDEwOlJlcG9zaXRvcnkxNDE3NTAzMjA=',
 'name': 'think-alouds',
 'full_name': 'capnrefsmmat/think-alouds',
 'private': True,
 'html_url': 'https://github.com/capnrefsmmat/think-alouds',
 'description': 'Think-aloud questions for intro statistics',
 'fork': False,
 'url': 'https://api.github.com/repos/capnrefsmmat/think-alouds',
 ...
}</code></pre>
<p>Other APIs may give the header a different name or expect a different kind of token, but this is the basic approach.</p>
</section>
<section id="posting-data" class="level3">
<h3 class="anchored" data-anchor-id="posting-data">POSTing data</h3>
<p>As we discussed above (<a href="#sec-http-methods" class="quarto-xref">Section&nbsp;1.1.3</a>), if you want to make a request that has side effects – adds new data, edits a record, deletes something, sends assassins to your enemies – you will likely use a <code>POST</code> request rather than a <code>GET</code> request.</p>
<p>In principle, a <code>POST</code> request consists of headers and a body, and the body can be anything that the server understands. In practice, there are a few common types and formats of request body.</p>
<p>Most bodies are a bunch of key-value pairs. For example, when I edit the preferences for my Wikipedia account and hit “Save”, my browser sends the following request:</p>
<pre><code>POST /wiki/Special:Preferences HTTP/2
Host: en.wikipedia.org
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/111.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: https://en.wikipedia.org/wiki/Special:Preferences
Content-Type: application/x-www-form-urlencoded
Content-Length: 3410
Origin: https://en.wikipedia.org
[...]

title=Special%3APreferences&amp;wplanguage=en&amp;wpgender=unknown&amp;wpemail-blacklist=&amp;wpskin=vector-2022&amp;wpskin-responsive=1&amp;[...]</code></pre>
<p>I’ve trimmed some of the superfluous headers and most of the request body, but you can see how the form works: each form field is sent with a key (the field name) and a value (the setting I chose).</p>
<p>We could make such a request in Requests by using <code>requests.post()</code>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.post(<span class="st">"https://en.wikipedia.org/wiki/Special:Preferences"</span>,</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                  data<span class="op">=</span>{<span class="st">"title"</span>: <span class="st">"Special:Preferences"</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"wplanguage"</span>: <span class="st">"en"</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"wpgender"</span>: <span class="st">"unknown"</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"wpemail-blacklist"</span>: <span class="va">None</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"wpskin"</span>: <span class="st">"vector-2022"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                        [...]})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That’s convenient, but this “urlencoded” format limits us to a simple set of key-value pairs. It’s hard to do more complicated data structures. Each value must be a string, so we can’t easily send lists except by sending the same key multiple times; and we can’t nest things unless we manually convert the nested data into strings.</p>
<p>That’s why many web applications and APIs use <a href="https://en.wikipedia.org/wiki/JSON">JSON</a>. JSON is a standard way to write dictionaries, lists, and other simple data as text. For example, you could write</p>
<pre><code>{
    "andrewid": "areinhar",
    "semester": "2023-spring",
    "courses": [
        {
            "number": 46927,
            "title": "Machine Learning II",
        },
        {
            "number": 36615,
            "title": "Software for Large-Scale Data",
        },
        {
            "number": 36616,
            "title": "Computational Methods for Statistics",
        },
    ]
}</code></pre>
<p>This actually matches Python syntax for dictionaries very closely, so it should be easy to see how a particular Python dictionary will be translated into a JSON string.</p>
<p>In Requests, you can simply pass a dictionary and ask for it to be sent as JSON:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.post(<span class="st">"https://www.example.com/some-api"</span>,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                  json<span class="op">=</span>some_big_dictionary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This automatically adds the <code>Content-Type: application/json</code> header, to notify the web server to process the request body as JSON. In some cases, APIs will process everything as JSON automatically; in other cases, they support multiple formats and require you to specify a <code>Content-Type</code> to ensure the data is handled correctly.</p>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<div id="exr-weather-api" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 1 (Weather forecasting)</strong></span> The National Weather Service, a US government agency, operates a <a href="https://www.weather.gov/documentation/services-web-api">weather API</a> that provides access to current weather conditions, forecasts, storm warnings, and related data in JSON format. All this weather data is publicly and freely available, so anyone who needs weather information can obtain it from the government at no cost. (In fact, commercial weather forecasters, like the Weather Channel or the weather apps built into phones, mainly process and repackage data from the National Weather Service.) The API is hosted at <a href="https://api.weather.gov" class="uri">https://api.weather.gov</a>.</p>
<p>In this exercise, your goal is to build a command-line Python script that can display the hourly forecast for a given location specified at the command line, using latitude and longitude. For example:</p>
<pre><code>$ python forecaster.py --interval=3 --periods=5 40.4397 -79.976

Hourly forecast for Pittsburgh, PA:

Thu 7 AM: Slight Chance Rain Showers, 54°F.
Thu 10 AM: Chance Rain Showers, 52°F.
Thu 1 PM: Chance Rain Showers, 53°F.
Thu 4 PM: Slight Chance Rain Showers, 53°F.
Thu 7 PM: Mostly Cloudy, 52°F.</code></pre>
<p>Notice that here we’ve asked for forecasts every 3 hours for 5 periods, but the API can give hourly forecasts several days into the future. You can add additional output formatting if you’d like, such as breaking the forecasts into blocks by date, adding umbrella and sunshine emoji, or even color-coding forecasts.</p>
<p>Some requirements and tips for your script:</p>
<ul>
<li>Use the <a href="https://docs.python.org/3/library/argparse.html">argparse module</a> to process the command-line arguments. Your script should accept the <code>--interval</code> and <code>--periods</code> arguments, as above, as well as the latitude and longitude. If <code>--interval</code> is not provided, default to an hourly forecast; if <code>--periods</code> is not provided, default to 24 periods.</li>
<li>The script should gracefully handle errors. For example:
<ul>
<li>What if the location requested does not have any forecasts available in the API?</li>
<li>What if the user requests more <code>--periods</code> than the API provides forecast, e.g.&nbsp;they request forecasts 400 hours into the future?</li>
<li>What if the API returns a server error or other bad status code?</li>
</ul></li>
<li>Use the requests package to make the API requests and decode the JSON into a Python dictionary.</li>
<li>Set a user-agent of “forecaster (yourandrew@andrew.cmu.edu)” for all requests you make to the API.</li>
<li>The Specification tab of the <a href="https://www.weather.gov/documentation/services-web-api">API Web Service page</a> documents all the available API URLs and what they require.</li>
<li>Your script will have to use two endpoints. The <code>/points/{point}</code> endpoint lets you look up a point by latitude and longitude and get the URL of the hourly forecast for that point; that URL will be to the <code>/gridpoints/{wfo}/{x},{y}/forecast/hourly</code> endpoint, which returns the hourly forecast.</li>
<li>All times returned by the API are in ISO 8601 format. Python’s <code>datetime</code> module can turn these into <code>datetime</code> objects using the <a href="https://docs.python.org/3/library/datetime.html#datetime.datetime.fromisoformat"><code>datetime.fromisoformat()</code> method</a>. You can then use the <a href="https://docs.python.org/3/library/datetime.html#strftime-strptime-behavior"><code>strftime()</code> method</a> to format the times for printing however you’d like.</li>
<li>Use good program design principles. That means splitting the code into reusable functions, and separating the fetching of data from its formatting for output.</li>
</ul>
<p>As a starting point, open <a href="https://api.weather.gov/points/40.4397,-79.976" class="uri">https://api.weather.gov/points/40.4397,-79.976</a> in your web browser. You should get a JSON reply giving details about that point, including the name of the nearby city, API URLs for its forecasts. Examining this manually will show you which fields your code should extract and use when printing its output. Similarly, you can open the hourly forecast endpoint in your browser to figure out how it is formatted and how to process it.</p>
<p>Turn in your Python script and an example hourly forecast for Pittsburgh, whose coordinates are shown above.</p>
<p><strong>Note:</strong> Please be careful and ensure your script does not send thousands of API requests in a loop. You should only need to make two requests each time the script is run. We don’t want to annoy the National Weather Service and risk a penalty hailstorm.</p>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>