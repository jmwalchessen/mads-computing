<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.34">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>web-scraping</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-c8ad9e5dbd60b7b70b38521ab19b7da4.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-57255bc51a02dad1602480f616b5f366.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="sec-scraping" class="level1">
<h1>Web Scraping</h1>
<p>Sometimes, the data you want isn’t available through a convenient API or as a downloadable file. It’s presented in a web page, but they don’t provide any way to get the data out of that page.</p>
<p>But the data is right there in the page, so surely we can get it out somehow! That process is called <em>scraping</em>.</p>
<p>To scrape data from a website, we must:</p>
<ol type="1">
<li>Connect to the right HTTP server.</li>
<li>Make an HTTP request for the right Web page.</li>
<li>Parse the HTML representing the page.</li>
<li>Extract the relevant text and data from the parsed HTML.</li>
</ol>
<p>We’ve already seen how to do Step 2 in <strong>?@sec-http</strong>. Let’s fill in the other pieces. It’s helpful to understand how the Internet works first, if only to better understand the kinds of error messages you’ll eventually run into.</p>
<section id="the-internet" class="level2">
<h2 class="anchored" data-anchor-id="the-internet">The Internet</h2>
<p>The Internet is the collective name for all the computers and routers connected together in one big system that we use. Email, Web sites, video calls, your Internet-connected doorbell – they all use the Internet to communicate with other systems, even if they do not use HTTP or Web pages as we know them.</p>
<section id="host-and-domain-names" class="level3">
<h3 class="anchored" data-anchor-id="host-and-domain-names">Host and domain names</h3>
<p>A machine connected to the Internet is a <em>host</em>. Each host has a <em>hostname</em>. On a Mac or Linux machine, you can run the <code>hostname</code> command to see your computer’s hostname; mine is currently <code>odobenus.local</code>.</p>
<p>That hostname means I’m on a network called <code>local</code> and my computer is called <code>odobenus</code>, apparently because I had a fondness for walruses when I first named it.</p>
<p>Hostnames can be assembled into <em>domain names</em>, which identify hosts on the Internet. For example, <code>andrew.cmu.edu</code> is a fully qualified domain name. Domain names are <em>hierarchical</em>, separated by dots, and are read right-to-left:</p>
<ul>
<li><code>[root zone]</code>: Conceptually, every fully qualified domain name is part of the <em>root zone</em>, which is controlled by the Internet Corporation for Assigned Names and Numbers (<a href="https://www.icann.org/">ICANN</a>). (ICANN was originally run under contract with the US Department of Commerce, but since 2016 it is independent, operating with input from 111 countries.)</li>
<li><code>edu</code>: A <em>top-level domain</em> (TLD) controlled by the organization Educause.</li>
<li><code>cmu</code>: Carnegie Mellon’s domain name.</li>
<li><code>andrew</code>: A specific host in Carnegie Mellon’s network.</li>
</ul>
<p>Top-level domains are created under ICANN’s authority, granting specific organizations authority to operate specific TLDs. Those TLDs (like <code>.edu</code> or <code>.org</code>) then sell name registrations to organizations like CMU. CMU then can create its own domains underneath its <code>cmu.edu</code> registration, acting as its own registration authority for names like <code>stat.cmu.edu</code> and <code>www.cmu.edu</code>.</p>
<p>(Incidentally, it is quite important that domain names are hierarchical. This is how you know that <code>securepayments.yourbank.com</code> is run by the same people who run <code>yourbank.com</code>, whereas <code>securepayments.yourbank.com.tech.mafia.ru</code> is run by the Russian Mafia, despite containing the same substring. Phishing sites will often use this trick to try to confuse you; remember to read right-to-left!)</p>
<p>Not every computer has a publicly accessible fully qualified domain name. My laptop currently does not, for example; outside of my local network, the hostname <code>odobenus.local</code> means nothing to anyone.</p>
<p>Domain names have to follow certain rules: for example, they do not contain spaces or underscore characters. Note that <code>http://www.stat.cmu.edu</code> or <code>andrew.cmu.edu/foo/bar</code> are <em>not</em> domain names; they are <a href="https://en.wikipedia.org/wiki/URL">Uniform Resource Locators</a> and refer to specific services hosted on specific domain names.</p>
</section>
<section id="ip-addresses-and-routing" class="level3">
<h3 class="anchored" data-anchor-id="ip-addresses-and-routing">IP addresses and routing</h3>
<p>Now, a domain name doesn’t get you much. If I want my computer to send something to the host at <code>andrew.cmu.edu</code>, how am I supposed to do that? I need a way to know which physical machine to deliver to.</p>
<p>Internet routers and switches don’t know how to find domain names, but they do understand <em>IP addresses</em>. An <a href="https://en.wikipedia.org/wiki/IP_address">IP address</a> is a numerical address; every machine connected to the public Internet has an IP address. (We’ll skip <a href="https://en.wikipedia.org/wiki/Network_address_translation">NAT</a> for now.)</p>
<p>IPv4 uses addresses like <code>172.16.254.1</code>, with four parts each containing an 8-bit (0 to 255) number; IPv6, the successor, uses addresses like <code>2001:db8:0:1234:0:567:8:1</code>, with eight parts each containing a 16-bit number encoded in hexadecimal. (The encoding is just for humans to look at; computers just look at the full 32-bit or 128-bit numbers.)</p>
<p>Crucially, IP addresses are hierarchical as well. For example, Carnegie Mellon owns the entire block of addresses from <code>128.2.0.0</code> to <code>128.2.255.255</code>, which includes every address beginning with <code>128.2</code>. The details are a bit out of scope here, but using <a href="https://en.wikipedia.org/wiki/Border_Gateway_Protocol">BGP</a>, CMU’s routers announce to other routers they’re connected to, “Hey, I know how to deliver to any address starting with <code>128.2</code>”, and <em>those</em> routers advertise to their neighbors “Hey, I have a way to get to <code>128.2</code>,” and so on, and so every router on the Internet knows someone who knows someone who knows someone who can deliver the message. This involves something called the <a href="https://en.wikipedia.org/wiki/Border_Gateway_Protocol">Border Gateway Protocol</a>.</p>
<p>The Internet is, basically, a big extended family where if you get a parking ticket, your sister says “oh, talk to our aunt, she knows the sister of a guy who was roommates with the cousin of the county clerk”, and the message gets passed from step to step until it gets to the right person.</p>
<p>But I don’t want to type in <code>128.2.12.64</code> to get the website at <code>stat.cmu.edu</code>. I want to just type in <code>stat.cmu.edu</code>. How do I do that?</p>
</section>
<section id="the-domain-name-system" class="level3">
<h3 class="anchored" data-anchor-id="the-domain-name-system">The Domain Name System</h3>
<p>The answer: the Domain Name System. When I type in <code>stat.cmu.edu</code>, my computer sends a DNS query to its friendly neighborhood DNS resolver (usually run by your Internet Service Provider). The DNS resolver follows several steps:</p>
<ul>
<li><code>[root zone]</code>: It asks DNS servers run by the root zone where to find the DNS servers for <code>.edu</code>. A master list of root DNS servers and their IP addresses has to be distributed manually; several organizations maintain root zone servers on behalf of ICANN. The root zone server responds with the IP address of a DNS server for <code>.edu</code>, such as <code>2001:501:b1f9::30</code>.</li>
<li><code>edu</code>: It asks the DNS server for <code>.edu</code> where to find the DNS server for <code>cmu.edu</code>, and receives a response like <code>128.237.148.168</code>.</li>
<li><code>cmu</code>: It asks the DNS server for <code>cmu.edu</code> where to find <code>stat.cmu.edu</code>, and receives a response like <code>128.2.12.64</code>.</li>
</ul>
<p>Obviously this involves a lot of back-and-forth communication, so resolvers usually have a <em>cache</em>. Every DNS server gives a <em>time-to-live</em> for its responses, indicating how long they can be relied upon; the resolver saves all responses it has received for that time period, so subsequent requests can be given the same answer.</p>
<p>Typical TTLs are on the range of hours to a day or two, which is why sometimes after website maintenance it can take a while for your access to be restored – your resolver might have an old invalid DNS response cached.</p>
<p>When you see error messages like “<code>example.com</code> could not be found”, your computer could not find a record for it in the Domain Name System.</p>
<p>Some systems distribute data via DNS. Some organizations run <a href="https://en.wikipedia.org/wiki/DNSBL">DNSBLs or RBLs</a> (DNS Blackhole List or Real-time Blackhole List), which provide ways to query if a domain name or host is known to be involved in spam mail. If your email server receives a message from <code>192.168.42.23</code>, it might do a DNS query for <code>23.42.168.192.dnsbl.example.net</code>; if the <code>example.net</code> RBL indicates that this IP is known to send spam, it will return an IP address, otherwise it will return a message that no such record is known.</p>
</section>
<section id="sending-data-with-tcp" class="level3">
<h3 class="anchored" data-anchor-id="sending-data-with-tcp">Sending data with TCP</h3>
<p>Once you have received the IP address corresponding to a domain name, how do you communicate with it?</p>
<p>There are layers here; <a href="https://en.wikipedia.org/wiki/OSI_model">seven layers</a>, specifically. Your computer needs a physical connection to other computers, either by cable or via electromagnetic field; communication over that connection has to be coordinated; messages have to be sent over that connection; those messages need to be reassembled into larger pieces with meaning; and those pieces need to be given meaning.</p>
<p>We’ll skip the physical layers. Suffice to say that Ethernet cables or Wi-Fi connections are involved.</p>
<p>Let’s talk about how we send messages and reassemble them. There are several ways to do this, but the one most often used is the <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">Transmission Control Protocol</a>.</p>
<p>TCP is a way of delivering messages between machines. It does not discriminate on the content of those messages; they may involve emails, video calls, Web pages, DNS queries, World of Warcraft game data, or anything else. TCP does not care or know anything about the specific uses of the messages.</p>
<p>TCP merely provides a way to deliver messages. It does so in steps:</p>
<ol type="1">
<li>Your computer sends a TCP message asking to connect to a particular server. That server replies with a message saying “Sounds good to me”, and your computer replies with a message saying “Great, let’s get to it”. This is the <em>connection handshake</em>. It’s what’s happening when you see “connecting to host…” messages.</li>
<li>Your computer takes the content of the message it wants to send and breaks it up into small pieces, called <em>packets</em>. Each packet is stamped with its destination IP address and a number indicating the order they’re supposed to be reassembled in. Your computer sends these to be delivered to the server.</li>
<li>As the server receives the packets, it sends acknowledgments (“ACK”). If a packet is lost, your computer can re-send it.</li>
<li>The server may reply with messages of its own, delivered in the same way, and messages can flow back and forth until one computer decides to close the connection and sends a “FIN” message (which has to be ACKed and matched with another FIN from the other computer).</li>
</ol>
<p>TCP is meant to be robust: if packets are lost (which happens surprisingly often!) they are re-sent, and packets can arrive in any order and be reassembled.</p>
<p>When you see error messages like “Could not connect to host” or “Connection refused”, there was a problem at step 1: the server failed to reply to your TCP connection request. Maybe there is no server actually listening at that IP address, or that computer is temporarily disconnected.</p>
<p>Now, if we connect to a server and make an HTTP request, what do we get?</p>
</section>
</section>
<section id="html" class="level2">
<h2 class="anchored" data-anchor-id="html">HTML</h2>
<p>HTML, the HyperText Markup Language, is a way of marking up text with various attributes and features to define a structure – a structure of paragraphs, boxes, headers, and so on, which can be given colors and styles and sizes with another language, CSS (Cascading Style Sheets).</p>
<p>For our purposes we don’t need to worry about CSS, since we don’t care what a page looks like, just what’s included in its HTML.</p>
<p>HTML defines a hierarchical tree structure. Let’s look at a minimal example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!doctype</span> html<span class="dt">&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> charset</span><span class="op">=</span><span class="st">"utf-8"</span><span class="dt">&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>An Awesome Website<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h1</span><span class="ot"> id</span><span class="op">=</span><span class="st">"awesome"</span><span class="dt">&gt;</span>Awesome Website<span class="dt">&lt;/</span><span class="kw">h1</span><span class="dt">&gt;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="ot"> id</span><span class="op">=</span><span class="st">"intro"</span><span class="dt">&gt;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      This is a paragraph of text linking</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      to <span class="dt">&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"http://example.com/page"</span><span class="dt">&gt;</span>another Web page.<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>This is another paragraph to introduce data <span class="dv">&amp;amp;</span> stuff:</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">table</span><span class="ot"> class</span><span class="op">=</span><span class="st">"datatable"</span><span class="ot"> id</span><span class="op">=</span><span class="st">"bigdata"</span><span class="dt">&gt;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;</span><span class="kw">thead</span><span class="dt">&gt;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;&lt;</span><span class="kw">th</span><span class="dt">&gt;</span>Key<span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;&lt;</span><span class="kw">th</span><span class="dt">&gt;</span>Value<span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;/</span><span class="kw">thead</span><span class="dt">&gt;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;</span><span class="kw">tbody</span><span class="dt">&gt;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&lt;</span><span class="kw">tr</span><span class="ot"> id</span><span class="op">=</span><span class="st">"importantrow"</span><span class="dt">&gt;&lt;</span><span class="kw">td</span><span class="dt">&gt;</span>Foo<span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;&lt;</span><span class="kw">td</span><span class="dt">&gt;</span>Bar<span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;&lt;</span><span class="kw">td</span><span class="dt">&gt;</span>Baz<span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;&lt;</span><span class="kw">td</span><span class="dt">&gt;</span>Bam<span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;/</span><span class="kw">tbody</span><span class="dt">&gt;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;/</span><span class="kw">table</span><span class="dt">&gt;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- This is a comment and is ignored --&gt;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Notice the use of <span class="dv">&amp;lt;</span>thead<span class="dv">&amp;gt;</span> and <span class="dv">&amp;lt;</span>tbody<span class="dv">&amp;gt;</span> tags, which are</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>      actually optional.</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice some features of HTML:</p>
<ul>
<li>Tags: Tags are named inside square brackets, like <code>&lt;h1&gt;</code>. There is a set of tags with predefined meanings, like <code>&lt;p&gt;</code> for paragraphs and <code>&lt;table&gt;</code> for tables. Tag names are case-insensitive, so <code>&lt;P&gt;</code> and <code>&lt;p&gt;</code> mean the same thing.</li>
<li>Tag hierarchy: Tags enclose text and other tags: tags open with a form like <code>&lt;p&gt;</code> and close with <code>&lt;/p&gt;</code>, and everything in between is enclosed in those tags. All tags have to be closed, except those that don’t. (Since people writing web pages were very bad at remembering to close tags, browsers now have standard rules for inferring when you meant to close a tag; notice the paragraphs above aren’t closed. Tables can’t be inside paragraphs, so the previous <code>&lt;p&gt;</code> does <em>not</em> contain the <code>&lt;table&gt;</code>.)</li>
<li>Attributes: Tags can have attributes, which are key-value pairs describing the content inside them. Many attributes have specific meaning: <code>id</code> is used for unique identifiers for elements, which can be used in JavaScript or CSS to modify those elements, and a <code>class</code> can be assigned to many elements which should somehow behave in the same way.</li>
<li>Escaping: Characters like <code>&lt;</code>, <code>&gt;</code>, and <code>&amp;</code> have specific meanings in HTML. If you want to write <code>&lt;</code> without it starting a new tag, you have to escape it by writing <code>&amp;lt;</code>. There are many escapes, like <code>&amp;copy;</code> for the copyright symbol, and numeric escapes for specifying arbitrary Unicode characters. These are called “HTML entities”.</li>
<li>Whitespace: Whitespace has no meaning in HTML. You could put the above HTML document on one line or four hundred, if you’d like. Spaces are collapsed: writing two spaces between words is the same as writing one space between words. Hence lines that wrap, above, don’t have excess spaces because of the indentation.</li>
</ul>
<p>Conceptually, HTML tags form a tree. Each tag has a parent (the enclosing tag) and children (the tags within). For example, above, the <code>&lt;body&gt;</code> tag’s parent is <code>&lt;html&gt;</code>, while its direct children are <code>&lt;h1&gt;</code>, <code>&lt;table&gt;</code>, and <code>&lt;p&gt;</code> tags.</p>
<section id="selecting-tags" class="level3">
<h3 class="anchored" data-anchor-id="selecting-tags">Selecting tags</h3>
<p>To pull information out of an HTML document, we may need only the contents of a few specific tags. There are several ways to do this, but they come down to needing a <em>selector</em>: some specification of the type or name of the tag we want.</p>
<p>There are several common types of selector. The simplest is the CSS selector, used when making Cascading Style Sheets. A CSS selector might look like this: <code>.datatable tr#importantrow td</code>.</p>
<p>That means:</p>
<ul>
<li><code>.datatable</code>: Any element with the <code>class</code> attribute “datatable”.</li>
<li><code>tr#importantrow</code>: Any tr element with the <code>id</code> attribute “importantrow”.</li>
<li><code>td</code>: Any <code>&lt;td&gt;</code> tag.</li>
</ul>
<p>These are interpreted hierarchically, so put together in one selector, this identifies all <code>td</code> elements inside a <code>tr</code> whose ID is “importantrow” inside some tag with class “datatable”. This will match two <code>td</code> elements in the example above. (Note that the <code>tbody</code> is not in the selector, but that is not a problem; any <code>td</code> inside a <code>tr#importantrow</code> matches, even if there are enclosing tags in between.)</p>
<p>Tag IDs and classes are particularly important for selectors, since they’re often used to mark specific parts of the page, or tags with specific uses. A tag can only have one ID, and an ID can only appear once in a page; but a tag can have multiple classes, separated by spaces in the class attribute:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> id</span><span class="op">=</span><span class="st">"sidebar"</span><span class="ot"> class</span><span class="op">=</span><span class="st">"left nav fixed"</span><span class="dt">&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Website authors add lots of class and ID attributes throughout a page because of their use in selectors. CSS is used to specify color, layout, backgrounds, sizes, and other features of tags on the page, and it uses selectors to identify which tags each rule applies to:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>p {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-family</span><span class="ch">:</span> <span class="dv">serif</span><span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-size</span><span class="ch">:</span> <span class="dv">110</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">color</span><span class="ch">:</span> <span class="cn">#333</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">.datatable</span> tr<span class="pp">#importantrow</span> td {</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">color</span><span class="ch">:</span> <span class="cn">#f00</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-weight</span><span class="ch">:</span> <span class="dv">bold</span><span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You’ll see CSS included in <code>&lt;style&gt;</code> tags on the page, or the page header will specify external CSS files that the browser is supposed to download and apply.</p>
</section>
<section id="parsing-html" class="level3">
<h3 class="anchored" data-anchor-id="parsing-html">Parsing HTML</h3>
<p>To “parse” a particular data format means to read it and extract all the pieces into some form you can manipulate in code. For HTML, that means turning the text above, with all its tags and attributes in one big string, into some kind of Python or R data structure we can use.</p>
<p>HTML’s complex structure makes it difficult to parse; the <a href="https://html.spec.whatwg.org/multipage/">HTML standard</a> chapter on syntax has headings going as deep as “<a href="https://html.spec.whatwg.org/multipage/parsing.html#numeric-character-reference-end-state">13.2.5.80 Numeric character reference end state</a>”. This means you should not try to write a parser yourself. <a href="https://stackoverflow.com/a/1732454">Nor should you attempt to parse HTML with regular expressions</a>.</p>
<p>In Python, we can use the <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">Beautiful Soup</a> package for parsing and working with HTML. It can parse HTML and then provides all kinds of functions to work with the tree of tags. See the <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/#installing-beautiful-soup">installation instructions</a> to get it installed.</p>
<p>For example, for the HTML shown above:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>soup <span class="op">=</span> BeautifulSoup(<span class="bu">open</span>(<span class="st">"example.html"</span>, <span class="st">"r"</span>).read())</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>ps <span class="op">=</span> soup.find_all(<span class="st">"p"</span>) <span class="co"># get a list of the 3 &lt;p&gt; tags</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>ps[<span class="dv">0</span>][<span class="st">"id"</span>] <span class="co"># "intro"</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>ps[<span class="op">-</span><span class="dv">1</span>].string <span class="co"># 'Notice the use of &lt;thead&gt; and &lt;tbody&gt; tags, which are\n      actually optional.\n  '</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>tds <span class="op">=</span> soup.css.select(<span class="st">".datatable tr#importantrow td"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>tds <span class="co"># [&lt;td&gt;Foo&lt;/td&gt;, &lt;td&gt;Bar&lt;/td&gt;]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">Beautiful Soup documentation</a> gives an extensive tutorial on how to use it to access specific attributes of a page, so we don’t need to recap that here. Instead, let’s consider the question: How do you figure out what parts of the HTML you need to extract?</p>
</section>
<section id="relative-urls" class="level3">
<h3 class="anchored" data-anchor-id="relative-urls">Relative URLs</h3>
<p>Back in <strong>?@sec-urls</strong>, we discussed the structure of URLs like <code>http://www.example.com/foo/bar.html</code>. When you parse a Web page, you may find URLs like this in <code>a</code> tags:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"http://www.example.com/foo/bar.html"</span><span class="dt">&gt;</span>the page<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is a complete URL. But just as there are absolute paths and relative paths for files on your computer, you can also use relative paths in URLs. For example, if we’re on the page <code>http://www.example.com/foo/index.html</code>, we can write a link like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"bar.html"</span><span class="dt">&gt;</span>the bar page<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is a <em>relative</em> URL. In this case, because we’re viewing it on a page in the <code>http://www.example.com/foo/</code> directory, it points to <code>http://www.example.com/foo/bar.html</code>. Other relative paths include:</p>
<ul>
<li><code>../baz/index.html</code>: points to <code>http://www.example.com/baz/index.html</code>, as <code>..</code> represents going to the parent directory</li>
<li><code>/index.html</code>: points to <code>http://www.example.com/index.html</code> regardless of which directory on the site we are in, as the leading <code>/</code> always indicates the root</li>
</ul>
<p>So when you extract URLs from links and other tags, you may need to parse those URLs to get the actual target URL, particularly if you want to make follow-up HTTP requests. Python’s <code>urllib</code> module provides tools to do this:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.parse</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>urllib.parse.urljoin(<span class="st">"http://www.example.com/foo/index.html"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"bar.html"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>urllib.parse.urljoin(<span class="st">"http://www.example.com/foo/index.html"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"../baz/index.html"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>urllib.parse.urljoin(<span class="st">"http://www.example.com/foo/index.html"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"/index.html"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>urllib.parse.urljoin(<span class="st">"http://www.example.com/foo/index.html"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"http://foo.example.com/index.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>urljoin()</code> method takes a base URL (the first argument) and a new URL (the second argument) and works out the absolute URL the new URL would point to.</p>
</section>
</section>
<section id="a-scraping-tutorial" class="level2">
<h2 class="anchored" data-anchor-id="a-scraping-tutorial">A scraping tutorial</h2>
<p>Let’s say you’d like to scrape some data from a web page. For instance, you’d like to pull information about books from an online bookstore: you’d like to get prices, review ratings, titles, and related information for an analysis of book markets.</p>
<p>Instead of Amazon, let’s use <a href="http://books.toscrape.com/">Books to Scrape</a>, an online store that exists to be scraped for demos like this.</p>
<section id="finding-what-you-need" class="level3">
<h3 class="anchored" data-anchor-id="finding-what-you-need">Finding what you need</h3>
<p>The page HTML contains lots of tags. (Web pages are often full of tags many layers deep, for all the buttons, boxes, popups, images, links, headers, and other junk on every webpage.) How do we find what we need?</p>
<p>Step 1 is to open the site in our web browser and find out which pages contain the information we need.</p>
<p>Step 2 is to open those pages and find the tags we want. Your browser’s web developer tools may be useful for this.</p>
<div id="exr-select-books" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 1 (In-class activity: select some book titles)</strong></span> Install Beautiful Soup using</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install beautifulsoup4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now load it and Requests:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now pull the Books to Scrape website using Requests and use Beautiful Soup to parse the HTML:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.get(<span class="st">"http://books.toscrape.com"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>soup <span class="op">=</span> BeautifulSoup(r.content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Use CSS selectors to extract a list of elements from which you can get:</p>
<ul>
<li>the title of each book</li>
<li>a link to the page with details about the book</li>
</ul>
<p>Run the code and verify that it works.</p>
</div>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<div id="exr-scrape-books" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 2 (Scraping some books)</strong></span> Let’s continue from <a href="#exr-select-books" class="quarto-xref">Exercise&nbsp;1</a> and scrape <a href="http://books.toscrape.com" class="uri">http://books.toscrape.com</a>.</p>
<p>For each book, we’d like:</p>
<ul>
<li>The book title</li>
<li>Its current price</li>
<li>Its UPC (Universal Product Code)</li>
<li>A link to the page with further details about the book</li>
</ul>
<p>Write a Python script that can be run from the command line that does this. It should write its output to standard output in CSV format, so you can run the command</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> scrape-books.py <span class="op">&gt;</span> books.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and get a file <code>books.csv</code> with four columns.</p>
<p>To do this, you’ll need to load each page of book listings from the site, use selectors to extract information, and load each book’s individual page to get the UPC. You’ll then store each book’s information somewhere so you can print it out, or just print it out immediately as you go.</p>
<p>Organize your code so that there are separate functions for getting information about books, and the printing of CSV output is done in separate code that calls those functions. That ensures you could later use the same functions to do something other than printing a CSV. Your CSV output should correctly handle book information containing commas, quotation marks, newlines, and any other characters with special meaning in CSVs.</p>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>